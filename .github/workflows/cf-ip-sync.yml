      - name: Scan IPs (2000 并发 · 终极优化)
        run: |
          result="/dev/shm/cfscan/result_raw.txt"
          echo "" > $result

          scan_ip() {
            ip=$1

            # 超快节点检测（0.2 秒）
            colo=$(curl -s --max-time 0.2 --resolve speed.cloudflare.com:80:$ip \
              http://speed.cloudflare.com/cdn-cgi/trace | grep '^colo=' | cut -d= -f2)

            [ -z "$colo" ] && return 0

            # 超快延迟检测（0.2 秒）
            latency=$(curl -o /dev/null -s --max-time 0.2 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)

            latency_ms=$(echo "$latency*1000" | bc 2>/dev/null)
            [ -z "$latency_ms" ] && latency_ms="9999"

            # ✅ 延迟过滤：200ms 以上直接丢弃
            if (( $(echo "$latency_ms >= 200" | bc -l) )); then
              return 0
            fi

            # 极速测速（512KB 文件 · 0.5 秒）
            speed_bytes=$(curl -o /dev/null -s --max-time 0.5 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{speed_download}" \
              "http://speed.cloudflare.com/__down?bytes=524288")

            speed_mb=$(echo "$speed_bytes/1024/1024" | bc 2>/dev/null)
            [ -z "$speed_mb" ] && speed_mb="0"

            echo "$ip $colo $latency_ms $speed_mb" >> $result
          }

          export -f scan_ip

          # 2000 并发（极限）
          cat /dev/shm/cfscan/ip_list.txt | xargs -n 1 -P 2000 bash -c 'scan_ip "$@"' _
