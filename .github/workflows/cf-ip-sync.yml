name: CF-IP-Scanner

permissions:
  contents: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y prips jq bc iputils-ping

      - name: Install Cloudflare WARP client
        run: |
          curl https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update
          sudo apt-get install -y cloudflare-warp

      - name: Start WARP (proxy mode)
        run: |
          sudo warp-cli --accept-tos registration new
          sudo warp-cli set-mode proxy
          sudo warp-cli set-proxy-port 40000
          sudo warp-cli connect
          sleep 5

          export ALL_PROXY="socks5://127.0.0.1:40000"
          if ! curl -s --max-time 8 https://www.cloudflare.com/cdn-cgi/trace | grep -q "warp="; then
            echo "WARP proxy failed"
            exit 1
          fi

      - name: Prepare CIDRs
        run: |
          mkdir -p /dev/shm/cfscan
          echo "104.16.0.0/13" > /dev/shm/cfscan/cidrs.txt
          echo "104.24.0.0/14" >> /dev/shm/cfscan/cidrs.txt
          echo "172.64.0.0/15" >> /dev/shm/cfscan/cidrs.txt
          echo "141.101.64.0/18" >> /dev/shm/cfscan/cidrs.txt
          echo "188.114.96.0/20" >> /dev/shm/cfscan/cidrs.txt
          echo "198.41.128.0/17" >> /dev/shm/cfscan/cidrs.txt
          echo "162.158.0.0/16" >> /dev/shm/cfscan/cidrs.txt
          echo "172.68.0.0/14" >> /dev/shm/cfscan/cidrs.txt

      - name: Build IP list
        run: |
          > /dev/shm/cfscan/ip_list.txt
          while read cidr; do
            prips "$cidr" | shuf -n 4096 >> /dev/shm/cfscan/ip_list.txt
          done < /dev/shm/cfscan/cidrs.txt

      - name: Scan IPs
        run: |
          result="/dev/shm/cfscan/result_raw.txt"
          : > "$result"
          export ALL_PROXY="socks5://127.0.0.1:40000"

          cat /dev/shm/cfscan/ip_list.txt | xargs -n 1 -P 200 -I {} bash -c '
            ip="{}"
            trace=$(curl -s --max-time 1 --resolve speed.cloudflare.com:80:$ip http://speed.cloudflare.com/cdn-cgi/trace)
            colo=$(echo "$trace" | grep "^colo=" | cut -d= -f2)
            [ -z "$colo" ] && exit 0

            latency=$(curl -o /dev/null -s --max-time 1 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)
            latency_ms=$(echo "$latency*1000" | bc)
            [ -z "$latency_ms" ] && latency_ms=9999

            if (( $(echo "$latency_ms >= 200" | bc -l) )); then exit 0; fi

            speed_bytes=$(curl -o /dev/null -s --max-time 1 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{speed_download}" \
              "http://speed.cloudflare.com/__down?bytes=524288")
            speed_mb=$(echo "$speed_bytes/1024/1024" | bc)
            [ -z "$speed_mb" ] && speed_mb=0

            echo "$ip $colo $latency_ms $speed_mb" >> "'"$result"'"
          '

      - name: Sort + Top20
        run: |
          if [ ! -s /dev/shm/cfscan/result_raw.txt ]; then
            : > valid_ips_full.txt
            : > top20.txt
            : > valid_ips.txt
          else
            sort -k3,3n -k4,4nr /dev/shm/cfscan/result_raw.txt > valid_ips_full.txt
            head -n 20 valid_ips_full.txt > top20.txt
            awk '{print $1"#"toupper($2)}' valid_ips_full.txt > valid_ips.txt
          fi

      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add .
            git commit -m "Update CF IP scan results"
            git push
          fi
