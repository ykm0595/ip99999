name: CF-IP-Scanner-MultiWARP

permissions:
  contents: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y prips wireguard-tools jq bc iputils-ping unzip golang

      - name: Install wgcf (fixed version)
        run: |
          wget -O wgcf https://github.com/ViRb3/wgcf/releases/download/v2.2.18/wgcf_2.2.18_linux_amd64
          chmod +x wgcf
          sudo mv wgcf /usr/local/bin/

      - name: Install wireproxy (build from Cloudflare Go mirror)
        run: |
          set -e
          # 使用 Go 模块镜像下载源码（proxy.golang.org 是 Cloudflare 托管）
          mkdir -p ~/go-wp
          cd ~/go-wp
          wget https://proxy.golang.org/github.com/octeep/wireproxy/@v/v1.0.6.zip -O wireproxy_v1.0.6.zip
          unzip wireproxy_v1.0.6.zip
          cd github.com/octeep/wireproxy@v1.0.6
          go build -o wireproxy ./cmd/wireproxy
          sudo mv wireproxy /usr/local/bin/
          chmod +x /usr/local/bin/wireproxy
          wireproxy -v || true

      - name: Setup 8 WARP SOCKS5 proxies
        run: |
          set -e

          rm -f wgcf-account.toml wgcf-profile.conf

          wgcf register --accept-tos
          wgcf generate

          PRIVATE_KEY=$(grep PrivateKey wgcf-profile.conf | head -n1 | awk '{print $3}')
          PUBLIC_KEY=$(grep PublicKey wgcf-profile.conf | head -n1 | awk '{print $3}')

          for i in $(seq 0 7); do
            port=$((40000 + i))
            addr=$((2 + i))
            conf="warp_${i}.conf"

            echo "[Interface]" > "$conf"
            echo "PrivateKey = $PRIVATE_KEY" >> "$conf"
            echo "Address = 172.16.0.${addr}/32" >> "$conf"
            echo "DNS = 1.1.1.1" >> "$conf"
            echo "MTU = 1280" >> "$conf"
            echo "[Peer]" >> "$conf"
            echo "PublicKey = $PUBLIC_KEY" >> "$conf"
            echo "AllowedIPs = 0.0.0.0/0" >> "$conf"
            echo "Endpoint = engage.cloudflareclient.com:2408" >> "$conf"
            echo "PersistentKeepalive = 25" >> "$conf"
            echo "[Socks5]" >> "$conf"
            echo "BindAddress = 127.0.0.1:${port}" >> "$conf"

            nohup wireproxy -c "$conf" >/dev/null 2>&1 &
          done

          sleep 8

          ok_count=0
          for i in $(seq 0 7); do
            port=$((40000 + i))
            echo "Testing WARP on port ${port}..."
            export ALL_PROXY="socks5://127.0.0.1:${port}"
            if curl -s --max-time 8 https://www.cloudflare.com/cdn-cgi/trace | grep -q "warp="; then
              echo "WARP instance ${i} OK"
              ok_count=$((ok_count + 1))
            else
              echo "WARP instance ${i} FAILED"
            fi
          done

          if [ "$ok_count" -lt 1 ]; then
            echo "All 8 WARP instances failed"
            exit 1
          fi

          echo "Total working WARP instances: $ok_count"

      - name: Load previous valid IPs
        run: |
          mkdir -p /dev/shm/cfscan
          if [ -f valid_ips.txt ]; then
            cp valid_ips.txt /dev/shm/cfscan/valid_old.txt
          fi

      - name: Prepare CIDRs
        run: |
          echo "104.16.0.0/13" > /dev/shm/cfscan/cidrs.txt
          echo "104.24.0.0/14" >> /dev/shm/cfscan/cidrs.txt
          echo "172.64.0.0/15" >> /dev/shm/cfscan/cidrs.txt
          echo "141.101.64.0/18" >> /dev/shm/cfscan/cidrs.txt
          echo "188.114.96.0/20" >> /dev/shm/cfscan/cidrs.txt
          echo "198.41.128.0/17" >> /dev/shm/cfscan/cidrs.txt
          echo "162.158.0.0/16" >> /dev/shm/cfscan/cidrs.txt
          echo "172.68.0.0/14" >> /dev/shm/cfscan/cidrs.txt

      - name: Build IP list and split to 8 shards
        run: |
          > /dev/shm/cfscan/ip_list.txt

          if [ -f /dev/shm/cfscan/valid_old.txt ]; then
            cut -d '#' -f1 /dev/shm/cfscan/valid_old.txt | shuf -n 8000 >> /dev/shm/cfscan/ip_list.txt
          else
            while read cidr; do
              prips "$cidr" | shuf -n 8192 >> /dev/shm/cfscan/ip_list.txt
            done < /dev/shm/cfscan/cidrs.txt
          fi

          split -n l/8 /dev/shm/cfscan/ip_list.txt /dev/shm/cfscan/ip_shard_

      - name: Scan IPs with 8 WARP instances
        run: |
          mkdir -p /dev/shm/cfscan/results
          for i in $(seq 0 7); do
            {
              shard="/dev/shm/cfscan/ip_shard_0${i}"
              [ -f "$shard" ] || exit 0
              result="/dev/shm/cfscan/results/result_${i}.txt"
              : > "$result"

              port=$((40000 + i))
              export ALL_PROXY="socks5://127.0.0.1:${port}"

              cat "$shard" | xargs -n 1 -P 100 -I {} bash -c '
                ip="{}"
                trace=$(curl -s --max-time 1 --resolve speed.cloudflare.com:80:$ip http://speed.cloudflare.com/cdn-cgi/trace)
                colo=$(echo "$trace" | grep "^colo=" | cut -d= -f2)
                [ -z "$colo" ] && exit 0

                latency=$(curl -o /dev/null -s --max-time 1 \
                  --resolve speed.cloudflare.com:80:$ip \
                  -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)
                latency_ms=$(echo "$latency*1000" | bc)
                [ -z "$latency_ms" ] && latency_ms=9999

                if (( $(echo "$latency_ms >= 200" | bc -l) )); then exit 0; fi

                speed_bytes=$(curl -o /dev/null -s --max-time 1 \
                  --resolve speed.cloudflare.com:80:$ip \
                  -w "%{speed_download}" \
                  "http://speed.cloudflare.com/__down?bytes=524288")
                speed_mb=$(echo "$speed_bytes/1024/1024" | bc)
                [ -z "$speed_mb" ] && speed_mb=0

                echo "$ip $colo $latency_ms $speed_mb" >> "'"$result"'"
              '
            } &
          done

          wait

          cat /dev/shm/cfscan/results/result_*.txt > /dev/shm/cfscan/result_raw.txt || true

      - name: Sort + Top20
        run: |
          if [ ! -s /dev/shm/cfscan/result_raw.txt ]; then
            echo "No valid IPs found"
            : > valid_ips_full.txt
            : > top20.txt
            : > valid_ips.txt
          else
            sort -k3,3n -k4,4nr /dev/shm/cfscan/result_raw.txt > valid_ips_full.txt
            head -n 20 valid_ips_full.txt > top20.txt
            awk '{print $1"#"toupper($2)}' valid_ips_full.txt > valid_ips.txt
          fi

      - name: Generate stats
        run: |
          if [ ! -s valid_ips_full.txt ]; then
            echo "日期：$(date -u)" > stats.txt
            echo "有效 IP：0" >> stats.txt
            echo "HKG：0" >> stats.txt
            echo "NRT：0" >> stats.txt
            echo "ICN：0" >> stats.txt
          else
            total=$(wc -l < valid_ips_full.txt)
            hkg=$(grep -i " hkg " valid_ips_full.txt | wc -l)
            nrt=$(grep -i " nrt " valid_ips_full.txt | wc -l)
            icn=$(grep -i " icn " valid_ips_full.txt | wc -l)
            echo "日期：$(date -u)" > stats.txt
            echo "有效 IP：$total" >> stats.txt
            echo "HKG：$hkg" >> stats.txt
            echo "NRT：$nrt" >> stats.txt
            echo "ICN：$icn" >> stats.txt
          fi

      - name: Save history
        run: |
          mkdir -p history
          ts=$(date -u +"%Y-%m-%d")
          if [ ! -s top20.txt ]; then
            echo "" > top20.txt
          fi
          jq -n \
            --arg date "$(date -u)" \
            --arg total "$(wc -l < valid_ips_full.txt 2>/dev/null || echo 0)" \
            --argjson top20 "$(jq -R -s -c 'split("\n")[:-1]' top20.txt)" \
            '{date:$date,total:$total,top20:$top20}' \
            > history/$ts.json

      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add .
            git commit -m "Update CF IP scan results (Multi-WARP)"
            git push
          fi
