name: test-warp

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools jq

      - name: Install wgcf
        run: |
          WGCF_URL=$(curl -s https://api.github.com/repos/ViRb3/wgcf/releases/latest | jq -r '.assets[0].browser_download_url')
          wget -O wgcf "$WGCF_URL"
          chmod +x wgcf
          sudo mv wgcf /usr/local/bin/

      - name: Install wireproxy
        run: |
          WIREPROXY_URL=$(curl -s https://api.github.com/repos/octeep/wireproxy/releases/latest | jq -r '.assets[] | select(.name | endswith(".deb")) | .browser_download_url')
          wget -O wireproxy.deb "$WIREPROXY_URL"
          sudo dpkg -i wireproxy.deb || sudo apt-get -f install -y

      - name: Setup WARP
        run: |
          wgcf register --accept-tos
          wgcf generate

          PRIVATE_KEY=$(grep PrivateKey wgcf-profile.conf | head -n1 | awk '{print $3}')
          PUBLIC_KEY=$(grep PublicKey wgcf-profile.conf | head -n1 | awk '{print $3}')

          cat > warp.conf <<EOF
[Interface]
PrivateKey = $PRIVATE_KEY
Address = 172.16.0.2/32

[Peer]
PublicKey = $PUBLIC_KEY
AllowedIPs = 0.0.0.0/0
Endpoint = engage.cloudflareclient.com:2408

[Socks5]
BindAddress = 127.0.0.1:40000
EOF

          nohup wireproxy -c warp.conf >/dev/null 2>&1 &
          sleep 5

      - name: Test WARP
        run: |
          export ALL_PROXY="socks5://127.0.0.1:40000"
          curl -s https://www.cloudflare.com/cdn-cgi/trace
