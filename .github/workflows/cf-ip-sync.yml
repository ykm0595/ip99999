name: Cloudflare-Region-Random-Scanner-WARP

permissions:
  contents: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies (prips + warp-cli)
        run: |
          sudo apt-get update
          sudo apt-get install -y prips
          sudo apt-get install -y cloudflare-warp

      - name: Register and enable WARP
        run: |
          sudo warp-cli register
          sudo warp-cli set-mode proxy
          sudo warp-cli set-proxy-port 40000
          sudo warp-cli connect
          sleep 3
          echo "WARP 已启用"

      - name: Load previous valid IPs (if exist)
        run: |
          mkdir -p /dev/shm/cfscan
          if [ -f valid_ips.txt ]; then
            echo "检测到历史有效 IP，优先使用"
            cp valid_ips.txt /dev/shm/cfscan/valid_old.txt
          else
            echo "没有历史有效 IP，将进行全量随机抽样"
          fi

      - name: Prepare region CIDRs
        run: |
          cat <<EOF > /dev/shm/cfscan/cidrs.txt
          # Hong Kong
          104.16.0.0/13
          104.24.0.0/14
          172.64.0.0/15

          # Japan
          141.101.64.0/18
          188.114.96.0/20
          198.41.128.0/17

          # Korea
          162.158.0.0/16
          172.68.0.0/14
          EOF

      - name: Build IP list (random or from valid)
        run: |
          > /dev/shm/cfscan/ip_list.txt

          if [ -f /dev/shm/cfscan/valid_old.txt ]; then
            echo "从历史有效 IP 中抽样 2000 个"
            cut -d '#' -f1 /dev/shm/cfscan/valid_old.txt | shuf -n 2000 >> /dev/shm/cfscan/ip_list.txt
          else
            echo "开始从 CIDR 随机抽样（每段 2048 个）"
            while read cidr; do
              [[ "$cidr" =~ ^# ]] && continue
              [[ -z "$cidr" ]] && continue
              prips $cidr | shuf -n 2048 >> /dev/shm/cfscan/ip_list.txt
            done < /dev/shm/cfscan/cidrs.txt
          fi

          echo "最终扫描 IP 数量：$(wc -l < /dev/shm/cfscan/ip_list.txt)"
          head -n 20 /dev/shm/cfscan/ip_list.txt

      - name: Scan IPs (800 并发 via WARP proxy)
        run: |
          result="/dev/shm/cfscan/result_raw.txt"
          echo "" > $result

          export ALL_PROXY="http://127.0.0.1:40000"

          echo "开始测速（通过 WARP）..."

          cat /dev/shm/cfscan/ip_list.txt | xargs -n 1 -P 800 -I {} sh -c '
            ip="{}"

            colo=$(curl -s --max-time 0.5 --resolve speed.cloudflare.com:80:$ip \
              http://speed.cloudflare.com/cdn-cgi/trace | grep "^colo=" | cut -d= -f2)
            [ -z "$colo" ] && exit 0

            latency=$(curl -o /dev/null -s --max-time 0.5 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)
            latency_ms=$(echo "$latency*1000" | bc 2>/dev/null)
            [ -z "$latency_ms" ] && latency_ms="9999"

            if (( $(echo "$latency_ms >= 200" | bc -l) )); then exit 0; fi

            loss=$(ping -c 3 -W 1 $ip 2>/dev/null | grep "packet loss" | awk -F% "{print \$1}" | awk "{print \$NF}")
            [ -z "$loss" ] && loss=100
            if (( $(echo "$loss > 50" | bc -l) )); then exit 0; fi

            speed_bytes=$(curl -o /dev/null -s --max-time 0.8 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{speed_download}" \
              "http://speed.cloudflare.com/__down?bytes=524288")
            speed_mb=$(echo "$speed_bytes/1024/1024" | bc 2>/dev/null)
            [ -z "$speed_mb" ] && speed_mb="0"

            printf "%s %s %s %s %s\n" "$ip" "$colo" "$latency_ms" "$speed_mb" "$loss" >> '"$result"'
          '

      - name: Save valid IPs for next run (IP#Region)
        run: |
          echo "保存有效 IP（带归属地）"

          awk '{
            ip=$1
            colo=$2
            gsub("\r","",colo)
            upper=toupper(colo)
            print ip "#" upper
          }' /dev/shm/cfscan/result_raw.txt > valid_ips.txt

          echo "有效 IP 数量：$(wc -l < valid_ips.txt)"
          head -n 20 valid_ips.txt

      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add valid_ips.txt
            git.commit -m "Update valid IPs (WARP)"
            git push
          else
            echo "没有变化，无需提交"
          fi
