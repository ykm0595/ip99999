name: Cloudflare-IP-Scanner

permissions:
  contents: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Cloudflare IPv4 ranges
        run: |
          mkdir -p /dev/shm/cfscan
          curl -s https://www.cloudflare.com/ips-v4 -o /dev/shm/cfscan/ips_v4.txt

          echo "=== Cloudflare IPv4 段 ==="
          cat /dev/shm/cfscan/ips_v4.txt

      - name: Expand IPv4 ranges to single IPs
        run: |
          echo "开始展开 IP 段..."
          > /dev/shm/cfscan/ip_list.txt

          while read cidr; do
            ipcalc -n $cidr | grep Network | awk '{print $2}' > /dev/shm/cfscan/net.txt
            ipcalc -b $cidr | grep Broadcast | awk '{print $2}' > /dev/shm/cfscan/bc.txt

            net=$(cat /dev/shm/cfscan/net.txt)
            bc=$(cat /dev/shm/cfscan/bc.txt)

            # 转换为整数
            IFS=. read -r n1 n2 n3 n4 <<< "$net"
            IFS=. read -r b1 b2 b3 b4 <<< "$bc"

            start=$(( (n1<<24) + (n2<<16) + (n3<<8) + n4 ))
            end=$(( (b1<<24) + (b2<<16) + (b3<<8) + b4 ))

            for ((i=start; i<=end; i++)); do
              ip="$(( (i>>24)&255 )).$(( (i>>16)&255 )).$(( (i>>8)&255 )).$(( i&255 ))"
              echo $ip >> /dev/shm/cfscan/ip_list.txt
            done
          done < /dev/shm/cfscan/ips_v4.txt

          echo "展开完成，共 $(wc -l < /dev/shm/cfscan/ip_list.txt) 个 IP"
          head -n 20 /dev/shm/cfscan/ip_list.txt

      - name: Scan IPs (800 并发)
        run: |
          result="/dev/shm/cfscan/result_raw.txt"
          echo "" > $result

          echo "开始测速..."

          cat /dev/shm/cfscan/ip_list.txt | xargs -n 1 -P 800 -I {} sh -c '
            ip="{}"

            # 节点检测
            colo=$(curl -s --max-time 0.2 --resolve speed.cloudflare.com:80:$ip \
              http://speed.cloudflare.com/cdn-cgi/trace | grep "^colo=" | cut -d= -f2)
            [ -z "$colo" ] && exit 0

            # 延迟检测
            latency=$(curl -o /dev/null -s --max-time 0.2 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)
            latency_ms=$(echo "$latency*1000" | bc 2>/dev/null)
            [ -z "$latency_ms" ] && latency_ms="9999"

            if (( $(echo "$latency_ms >= 200" | bc -l) )); then exit 0; fi

            # 丢包检测
            loss=$(ping -c 3 -W 1 $ip 2>/dev/null | grep "packet loss" | awk -F% "{print \$1}" | awk "{print \$NF}")
            [ -z "$loss" ] && loss=100
            if (( $(echo "$loss > 50" | bc -l) )); then exit 0; fi

            # 速度测试（512KB）
            speed_bytes=$(curl -o /dev/null -s --max-time 0.5 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{speed_download}" \
              "http://speed.cloudflare.com/__down?bytes=524288")
            speed_mb=$(echo "$speed_bytes/1024/1024" | bc 2>/dev/null)
            [ -z "$speed_mb" ] && speed_mb="0"

            isp="cloudflare"

            printf "%s %s %s %s %s %s\n" "$ip" "$colo" "$latency_ms" "$speed_mb" "$loss" "$isp" >> '"$result"'
          '

          echo "=== 原始测速结果前 20 行 ==="
          head -n 20 "$result"

      - name: Sort and save results
        run: |
          result="/dev/shm/cfscan/result_raw.txt"

          if [ ! -s "$result" ]; then
            echo "没有测速结果，跳过生成文件。"
            exit 0
          fi

          echo "生成 TXT..."
          sort -k4 -nr $result | head -n 50 | awk \
            "{print \$1\"#\"\$2\"#\"\$3\"ms#\"\$4\"MB/s#loss=\"\$5\"#\"\$6}" \
            > cf_fast_top50.txt

          echo "生成 CSV..."
          echo "ip,colo,latency_ms,speed_mb,loss,isp" > cf_fast_top50.csv
          sort -k4 -nr $result | head -n 50 >> cf_fast_top50.csv

          echo "生成 JSON..."
          sort -k4 -nr $result | head -n 50 | awk '
            BEGIN { print "[" }
            {
              printf "  {\"ip\":\"%s\",\"colo\":\"%s\",\"latency_ms\":%s,\"speed_mb\":%s,\"loss\":%s,\"isp\":\"%s\"}",
                $1,$2,$3,$4,$5,$6
              if (NR < 50) print ","; else print ""
            }
            END { print "]" }
          ' > cf_fast_top50.json

      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add cf_fast_top50.txt cf_fast_top50.csv cf_fast_top50.json
            git commit -m "Update Cloudflare Scan"
            git push
          else
            echo "没有变化，无需提交。"
          fi
