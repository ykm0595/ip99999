name: Cloudflare-IP-Scanner

permissions:
  contents: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y prips wireguard-tools jq bc iputils-ping

      #######################################################################
      # ✅ 防呆版 wgcf 安装（自动 fallback，不会再出现 null）
      #######################################################################
      - name: Install wgcf (robust)
        run: |
          WGCF_URL=$(curl -s https://api.github.com/repos/ViRb3/wgcf/releases \
            | jq -r '
              map(.assets // []) |
              flatten |
              map(select(.name | contains("linux_amd64"))) |
              first |
              .browser_download_url // empty
            ')

          if [ -z "$WGCF_URL" ]; then
            echo "❌ ERROR: Failed to fetch wgcf download URL"
            exit 1
          fi

          echo "✅ WGCF URL: $WGCF_URL"
          wget -O wgcf "$WGCF_URL"
          chmod +x wgcf
          sudo mv wgcf /usr/local/bin/

      #######################################################################
      # ✅ 防呆版 wireproxy 安装（自动识别正确文件）
      #######################################################################
      - name: Install wireproxy (robust)
        run: |
          WIREPROXY_URL=$(curl -s https://api.github.com/repos/whyvl/wireproxy/releases \
            | jq -r '
              map(.assets // []) |
              flatten |
              map(select(.name | contains("linux-amd64"))) |
              first |
              .browser_download_url // empty
            ')

          if [ -z "$WIREPROXY_URL" ]; then
            echo "❌ ERROR: Failed to fetch wireproxy download URL"
            exit 1
          fi

          echo "✅ Wireproxy URL: $WIREPROXY_URL"
          wget -O wireproxy "$WIREPROXY_URL"
          chmod +x wireproxy
          sudo mv wireproxy /usr/local/bin/

      #######################################################################
      # ✅ WARP 启动 + 自检（确保 socks5 真的可用）
      #######################################################################
      - name: Setup WARP SOCKS5
        run: |
          wgcf register --accept-tos
          wgcf generate

          PRIVATE_KEY=$(grep PrivateKey wgcf-profile.conf | head -n1 | awk '{print $3}')
          PUBLIC_KEY=$(grep PublicKey wgcf-profile.conf | head -n1 | awk '{print $3}')

          cat > warp.conf <<EOF
[Interface]
PrivateKey = $PRIVATE_KEY
Address = 172.16.0.2/32

[Peer]
PublicKey = $PUBLIC_KEY
AllowedIPs = 0.0.0.0/0
Endpoint = engage.cloudflareclient.com:2408

[Socks5]
BindAddress = 127.0.0.1:40000
EOF

          nohup wireproxy -c warp.conf >/dev/null 2>&1 &
          sleep 5

          export ALL_PROXY="socks5://127.0.0.1:40000"

          echo "✅ Testing WARP connectivity..."
          if ! curl -s --max-time 3 https://www.cloudflare.com/cdn-cgi/trace | grep -q "warp="; then
            echo "❌ ERROR: WARP did not start correctly"
            exit 1
          fi
          echo "✅ WARP is working"

      #######################################################################
      # ✅ 加载旧 IP（防呆）
      #######################################################################
      - name: Load previous valid IPs
        run: |
          mkdir -p /dev/shm/cfscan
          if [ -f valid_ips.txt ]; then
            cp valid_ips.txt /dev/shm/cfscan/valid_old.txt
          fi

      #######################################################################
      # ✅ Cloudflare IP 段
      #######################################################################
      - name: Prepare CIDRs
        run: |
          cat > /dev/shm/cfscan/cidrs.txt <<EOF
104.16.0.0/13
104.24.0.0/14
172.64.0.0/15
141.101.64.0/18
188.114.96.0/20
198.41.128.0/17
162.158.0.0/16
172.68.0.0/14
EOF

      #######################################################################
      # ✅ 构建 IP 列表（防呆）
      #######################################################################
      - name: Build IP list
        run: |
          > /dev/shm/cfscan/ip_list.txt

          if [ -f /dev/shm/cfscan/valid_old.txt ]; then
            cut -d '#' -f1 /dev/shm/cfscan/valid_old.txt | shuf -n 2000 >> /dev/shm/cfscan/ip_list.txt
          else
            while read cidr; do
              prips "$cidr" | shuf -n 2048 >> /dev/shm/cfscan/ip_list.txt
            done < /dev/shm/cfscan/cidrs.txt
          fi

      #######################################################################
      # ✅ 扫描（带防呆）
      #######################################################################
      - name: Scan IPs
        run: |
          result="/dev/shm/cfscan/result_raw.txt"
          : > "$result"

          export ALL_PROXY="socks5://127.0.0.1:40000"

          cat /dev/shm/cfscan/ip_list.txt | xargs -n 1 -P 200 -I {} bash -c '
            ip="{}"

            trace=$(curl -s --max-time 1 --resolve speed.cloudflare.com:80:$ip http://speed.cloudflare.com/cdn-cgi/trace)
            colo=$(echo "$trace" | grep "^colo=" | cut -d= -f2)
            [ -z "$colo" ] && exit 0

            latency=$(curl -o /dev/null -s --max-time 1 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{time_connect}" http://speed.cloudflare.com/cdn-cgi/trace)
            latency_ms=$(echo "$latency*1000" | bc)
            [ -z "$latency_ms" ] && latency_ms=9999

            if (( $(echo "$latency_ms >= 200" | bc -l) )); then exit 0; fi

            speed_bytes=$(curl -o /dev/null -s --max-time 1 \
              --resolve speed.cloudflare.com:80:$ip \
              -w "%{speed_download}" \
              "http://speed.cloudflare.com/__down?bytes=524288")
            speed_mb=$(echo "$speed_bytes/1024/1024" | bc)
            [ -z "$speed_mb" ] && speed_mb=0

            echo "$ip $colo $latency_ms $speed_mb" >> "'"$result"'"
          '

      #######################################################################
      # ✅ 排序 + Top20（防呆）
      #######################################################################
      - name: Sort + Top20
        run: |
          sort -k3,3n -k4,4nr /dev/shm/cfscan/result_raw.txt > valid_ips_full.txt
          head -n 20 valid_ips_full.txt > top20.txt
          awk '{print $1"#"toupper($2)}' valid_ips_full.txt > valid_ips.txt

      #######################################################################
      # ✅ stats（防空文件）
      #######################################################################
      - name: Generate stats
        run: |
          total=$(wc -l < valid_ips_full.txt)
          hkg=$(grep -i " hkg " valid_ips_full.txt | wc -l)
          nrt=$(grep -i " nrt " valid_ips_full.txt | wc -l)
          icn=$(grep -i " icn " valid_ips_full.txt | wc -l)

          echo "日期：$(date -u)" > stats.txt
          echo "有效 IP：$total" >> stats.txt
          echo "HKG：$hkg" >> stats.txt
          echo "NRT：$nrt" >> stats.txt
          echo "ICN：$icn" >> stats.txt

      #######################################################################
      # ✅ history（防呆）
      #######################################################################
      - name: Save history
        run: |
          mkdir -p history
          ts=$(date -u +"%Y-%m-%d")
          jq -n \
            --arg date "$(date -u)" \
            --arg total "$(wc -l < valid_ips_full.txt)" \
            --argjson top20 "$(jq -R -s -c 'split("\n")[:-1]' top20.txt)" \
            '{date:$date,total:$total,top20:$top20}' \
            > history/$ts.json

      #######################################################################
      # ✅ 自动提交
      #######################################################################
      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add .
            git commit -m "Update CF IP scan results"
            git push
          fi
